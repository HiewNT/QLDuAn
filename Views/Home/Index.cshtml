@{
    ViewData["Title"] = "Bảng điều khiển quản trị";
    var duAnProgress = ViewBag.DuAnProgress as IEnumerable<dynamic>;
    var toCongViec = ViewBag.ToCongViec as IEnumerable<dynamic>;
}

<div class="container-fluid">
    <!-- Header Section with Breadcrumb -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 mb-2">
                    <li class="breadcrumb-item"><a href="#" class="text-decoration-none">Trang chủ</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0 text-dark fw-bold">
                        <i class="bi bi-speedometer2 me-2 text-primary"></i>Bảng điều khiển
                    </h1>
                </div>
            </div>
            <div class="text-muted small mt-2">
                <i class="bi bi-clock me-1"></i>Cập nhật lần cuối: <span id="lastUpdate">@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</span>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-5">
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm h-100 stats-card" data-aos="fade-up" data-aos-delay="0">
                <div class="card-body position-relative overflow-hidden">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stats-icon bg-primary">
                                <i class="bi bi-people fs-3"></i>
                            </div>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="text-muted mb-1 text-uppercase small fw-semibold">Người dùng</h6>
                            <h2 class="mb-0 fw-bold text-dark counter" data-target="@ViewBag.SoNguoiDung">0</h2>
                        </div>
                    </div>
                    <div class="stats-bg-icon">
                        <i class="bi bi-people"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="@Url.Action("Index", "NguoiDung")" class="btn btn-outline-primary btn-sm w-100">
                        <i class="bi bi-arrow-right me-1"></i>Quản lý người dùng
                    </a>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm h-100 stats-card" data-aos="fade-up" data-aos-delay="100">
                <div class="card-body position-relative overflow-hidden">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stats-icon bg-success">
                                <i class="bi bi-folder-fill fs-3"></i>
                            </div>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="text-muted mb-1 text-uppercase small fw-semibold">Dự án</h6>
                            <h2 class="mb-0 fw-bold text-dark counter" data-target="@ViewBag.SoDuAn">0</h2>
                        </div>
                    </div>
                    <div class="stats-bg-icon">
                        <i class="bi bi-folder-fill"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="@Url.Action("Index", "DuAn")" class="btn btn-outline-success btn-sm w-100">
                        <i class="bi bi-arrow-right me-1"></i>Quản lý dự án
                    </a>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm h-100 stats-card" data-aos="fade-up" data-aos-delay="200">
                <div class="card-body position-relative overflow-hidden">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stats-icon bg-warning">
                                <i class="bi bi-list-check fs-3"></i>
                            </div>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="text-muted mb-1 text-uppercase small fw-semibold">Công việc</h6>
                            <h2 class="mb-0 fw-bold text-dark counter" data-target="@ViewBag.SoCongViec">0</h2>
                        </div>
                    </div>
                    <div class="stats-bg-icon">
                        <i class="bi bi-list-check"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="@Url.Action("Index", "CongViec")" class="btn btn-outline-warning btn-sm w-100">
                        <i class="bi bi-arrow-right me-1"></i>Quản lý công việc
                    </a>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm h-100 stats-card" data-aos="fade-up" data-aos-delay="300">
                <div class="card-body position-relative overflow-hidden">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stats-icon bg-info">
                                <i class="bi bi-file-earmark-text-fill fs-3"></i>
                            </div>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="text-muted mb-1 text-uppercase small fw-semibold">Tài liệu</h6>
                            <h2 class="mb-0 fw-bold text-dark counter" data-target="@ViewBag.SoTaiLieu">0</h2>
                        </div>
                    </div>
                    <div class="stats-bg-icon">
                        <i class="bi bi-file-earmark-text-fill"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="@Url.Action("Index", "TaiLieu")" class="btn btn-outline-info btn-sm w-100">
                        <i class="bi bi-arrow-right me-1"></i>Quản lý tài liệu
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row g-4 mb-4">
        <!-- Quick Actions -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100" data-aos="fade-right">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0 d-flex align-items-center">
                        <i class="bi bi-lightning-fill text-primary me-2"></i>Thao tác nhanh
                    </h5>
                    <small class="text-muted">Các tác vụ thường dùng</small>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-3">
                        <a href="@Url.Action("Create", "DuAn")" class="btn btn-light border p-3 text-start quick-action-btn">
                            <div class="d-flex align-items-center">
                                <div class="quick-action-icon bg-success-subtle text-success me-3">
                                    <i class="bi bi-plus-circle"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">Tạo dự án mới</div>
                                    <small class="text-muted">Khởi tạo dự án và phân công</small>
                                </div>
                            </div>
                        </a>
                        
                        <a href="@Url.Action("Create", "CongViec")" class="btn btn-light border p-3 text-start quick-action-btn">
                            <div class="d-flex align-items-center">
                                <div class="quick-action-icon bg-warning-subtle text-warning me-3">
                                    <i class="bi bi-plus-circle"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">Thêm công việc</div>
                                    <small class="text-muted">Tạo task và gán người thực hiện</small>
                                </div>
                            </div>
                        </a>
                        
                        <a href="@Url.Action("Create", "NguoiDung")" class="btn btn-light border p-3 text-start quick-action-btn">
                            <div class="d-flex align-items-center">
                                <div class="quick-action-icon bg-primary-subtle text-primary me-3">
                                    <i class="bi bi-person-plus"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">Thêm người dùng</div>
                                    <small class="text-muted">Mời thành viên tham gia</small>
                                </div>
                            </div>
                        </a>
                        
                        <a href="@Url.Action("Create", "TaiLieu")" class="btn btn-light border p-3 text-start quick-action-btn">
                            <div class="d-flex align-items-center">
                                <div class="quick-action-icon bg-info-subtle text-info me-3">
                                    <i class="bi bi-cloud-upload"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">Upload tài liệu</div>
                                    <small class="text-muted">Tải lên và chia sẻ file</small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Progress Chart -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100" data-aos="fade-left">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-bar-chart text-success me-2"></i>Tiến độ dự án
                        </h5>
                        <small class="text-muted">Tình hình thực hiện các dự án</small>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="@Url.Action("Index", "DuAn")">Xem tất cả dự án</a></li>
                            <li><a class="dropdown-item" href="#">Xuất báo cáo</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">Cài đặt hiển thị</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    @if (duAnProgress != null && duAnProgress.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0">Dự án</th>
                                        <th class="border-0 text-center">Tổng CV</th>
                                        <th class="border-0 text-center">Hoàn thành</th>
                                        <th class="border-0">Tiến độ</th>
                                        <th class="border-0 text-center">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var d in duAnProgress)
                                    {
                                        var percentage = d.TongCV > 0 ? (int)((double)d.HoanThanh * 100 / d.TongCV) : 0;
                                        var statusClass = percentage >= 80 ? "success" : percentage >= 50 ? "warning" : "danger";
                                        var statusText = percentage >= 80 ? "Sắp hoàn thành" : percentage >= 50 ? "Đang thực hiện" : "Chậm tiến độ";
                                        
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="project-avatar bg-primary-subtle text-primary rounded me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                        @(d.TenDuAn.ToString().Substring(0, 1).ToUpper())
                                                    </div>
                                                    <div>
                                                        <div class="fw-semibold">@d.TenDuAn</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-secondary-subtle text-secondary">@d.TongCV</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-success-subtle text-success">@d.HoanThanh</span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                        <div class="progress-bar bg-@statusClass" style="width: @percentage%"></div>
                                                    </div>
                                                    <small class="text-muted fw-semibold">@percentage%</small>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-@statusClass-subtle text-@statusClass">@statusText</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">Chưa có dự án nào</p>
                            <a href="@Url.Action("Create", "DuAn")" class="btn btn-primary btn-sm">Tạo dự án đầu tiên</a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    
</div>


<link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
<script>
    // Animate counter number incrementally
    function animateCounters() {
        const counters = document.querySelectorAll('.counter');
        counters.forEach(counter => {
            const target = +counter.getAttribute('data-target');
            let count = +counter.innerText;
            const increment = Math.ceil(target / 100);

            function updateCount() {
                if (count < target) {
                    count += increment;
                    if (count > target) count = target;
                    counter.innerText = count;
                    setTimeout(updateCount, 20);
                } else {
                    counter.innerText = target;
                }
            }

            updateCount();
        });
    }


    // Init on page load
    document.addEventListener('DOMContentLoaded', function () {
        animateCounters();

        // Init AOS if loaded
        if (typeof AOS !== 'undefined') {
            AOS.init({
                duration: 800,
                once: true,
                offset: 100
            });
        }

        // Handle dropdown filter click
        document.querySelectorAll('.dropdown-menu a').forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                const button = this.closest('.dropdown').querySelector('.dropdown-toggle');
                button.innerHTML = `${this.textContent}`;
                refreshData(); // Refresh when filter changes
            });
        });
    });
</script>
